# tap-tools workspace management
SHELL := /bin/bash

# Development shortcuts
.PHONY: dev-termtap dev-webtap dev-logtap
dev-termtap:
	@uv run --package termtap termtap

dev-webtap:
	@uv run --package webtap webtap

dev-logtap:
	@uv run --package logtap logtap

# Generic release template
# Usage: make release-termtap, make release-webtap, etc.
.PHONY: release-%
release-%:
	@if [ ! -d "packages/$*" ]; then \
		echo "Error: Package $* not found in packages/"; \
		exit 1; \
	fi
	@VERSION=$$(grep '^version = ' packages/$*/pyproject.toml | cut -d'"' -f2); \
	echo "Releasing $* v$$VERSION..."; \
	git tag -a $*-v$$VERSION -m "Release $* v$$VERSION"; \
	uv tool install packages/$*; \
	echo "✓ Tagged and installed $* v$$VERSION"; \
	echo "✓ Now '$*' runs the released version"; \
	echo "Push with: git push origin $*-v$$VERSION"

# Workspace operations
.PHONY: sync format lint check

sync:
	@echo "Syncing workspace dependencies..."
	@uv sync

format:
	@uv run ruff format .

lint:
	@uv run ruff check . --fix

check:
	@basedpyright

# Generic build check template
# Usage: make check-termtap, make check-webtap, etc.
.PHONY: check-%
check-%:
	@if [ ! -d "packages/$*" ]; then \
		echo "Error: Package $* not found in packages/"; \
		exit 1; \
	fi
	@echo "Checking $* for distribution readiness..."
	@uv build --package $* --no-sources
	@echo "✓ $* builds without local dependencies"

# Add dependency to package
# Usage: make add-dep-termtap DEP="fastapi>=0.100.0"
.PHONY: add-dep-%
add-dep-%:
	@if [ -z "$(DEP)" ]; then \
		echo "Error: DEP variable required. Usage: make add-dep-termtap DEP='package>=1.0.0'"; \
		exit 1; \
	fi
	@echo "Adding $(DEP) to $*..."
	@uv add --package $* $(DEP)
	@echo "✓ Added $(DEP) to $*"

# Add optional dependency to package
# Usage: make add-opt-termtap GROUP=dev DEP="pytest>=7.0.0"
.PHONY: add-opt-%
add-opt-%:
	@if [ -z "$(GROUP)" ] || [ -z "$(DEP)" ]; then \
		echo "Error: GROUP and DEP required. Usage: make add-opt-termtap GROUP=dev DEP='pytest>=7.0.0'"; \
		exit 1; \
	fi
	@echo "Adding $(DEP) to $* optional group [$(GROUP)]..."
	@uv add --package $* --optional $(GROUP) $(DEP)
	@echo "✓ Added $(DEP) to $* [$(GROUP)]"